# MQTT Benchmark Tool

## Описание
Инструмент тестирует производительность MQTT-брокеров в четырёх режимах: постоянная нагрузка для базовых измерений, пакетная отправка для стресс-тестов, плавное наращивание нагрузки для проверки масштабируемости и случайный трафик для имитации реальных условий. Система собирает ключевые метрики: задержки доставки сообщений (с перцентилями P50/P95/P99), пропускную способность и процент успешной доставки. Поддерживаются версии протокола MQTT 3.1.1 и 5.0 с полной проверкой всех уровней QoS (0, 1 и 2) для контроля гарантий доставки. Соответствуя принципам 12-factor app, инструмент настраивается через переменные окружения и формирует детальные отчёты в JSON-формате, содержащие временные метки измерений, статистику использования ресурсов и данные об успешных/неудачных доставках сообщений.

## Запуск
1. Устанавливаем бинарник и пример файла переменной окружения на рабочую машину
2. Редактируем название файла переменной окружения
3. Настраиваем файл переменной окружения: Уровень логирования, настройки подключения к брокеру MQTT, паттерн топиков, режим и настройки нагрузки, путь генерации файла отчета, порт метрик.
    - При выборе режима нагрузки необходимо закомментировать параметры относящиеся к другим режимам, поскольку у каждого режима свои возможные параметры
    - Присутствуют два эндпоинта HTTP-сервера с метриками /metrics и /debug/metrics
    - Особенности constant-режима - нет равномерной нагрузки распределения сигналов в разрезе одной секунды, возникают "spikes" на брокер/сеть в начале каждой секунды, выполнено в целях оптимизации работы бенчмарка
    - При отсутствии параметров в конфиге будут взяты дефолтные значения конфигурации
    - Если в логах в первых сообщениях WARN упущенных параметров указан нужный вам параметр, то значит вы его не указали и принято дефолтное значение, также там указываются параметры остальных режимов, которые в этой сессии могут не применяться - это нормально
    - В отчете указано полная работа программы из-за чего средняя скорость отправки сообщения искажено и носит информативый контекст, для точных исследований лучше пользоваться метриками Prometheus или брокера.
4. Запускаем бинарник

## Основные возможности

### Режимы работы
Инструмент поддерживает 4 режима нагрузки с различными характеристиками:

| Режим        | Описание                                                                 | Ключевые параметры                     |
|--------------|--------------------------------------------------------------------------|----------------------------------------|
| **Constant** | Равномерная отправка сообщений с фиксированной частотой                  | `SIGNALS_PER_SECOND`                   |
| **Burst**    | Пакетная отправка сообщений с заданными интервалами                      | `BURST_SIZE`, `BURST_INTERVAL_MS`      |
| **Ramp-up**  | Плавное нарастание нагрузки от начального до максимального значения      | `START_RATE`, `END_RATE`, `RAMP_DURATION_SEC` |
| **Random**   | Случайная нагрузка в заданном диапазоне                                  | `MIN_RATE`, `MAX_RATE`                 |

### Генерация сообщений
- Автоматическое создание тестовых сообщений
- Поддержка динамических топиков с параметрами:
  - `{device_id}` - случайный ID устройства (1-1000)
  - `{control_id}` - случайный ID контрола (1-10)
- Полезная нагрузка (payload) - случайные числовые значения (0-100)

### Мониторинг и метрики
Встроенная система сбора метрик:
- Пропускная способность (сообщений/сек)
- Задержки публикации (гистограмма)
- Количество успешных/неудачных отправок
- Объем переданных данных (payload + топики)
- Время работы (uptime)

**Экспорт метрик:**
- Prometheus endpoint (`/metrics`)
- Системные метрики (`/debug/metrics`)
- JSON-отчет по завершении теста

### Отчетность
Автоматическая генерация отчета с ключевыми показателями:
- Использованный режим работы
- Общее количество сообщений
- Процент успешных отправок
- Средняя скорость публикации
- Длительность тестирования
- Временные метки начала/окончания

### Конфигурация
Гибкая система настроек через:
1. Переменные окружения
2. `.env` файл
3. Параметры командной строки

Поддерживает настройку:
- Подключения к брокеру
- Настройки сообщений
- Параметров нагрузки
- Порта для метрик
- Уровня логирования
- Пути файла отчета

### Технические особенности
- Кросс-платформенная работа (Windows/Linux/macOS)

### Зависимости используемые в коде
- [Eclipse Paho MQTT](https://github.com/eclipse/paho.mqtt.golang) - клиент MQTT
- [Prometheus Client](https://github.com/prometheus/client_golang) - сбор метрик
- [Zerolog](https://github.com/rs/zerolog) - логирование
- [Godotenv](https://github.com/joho/godotenv) - загрузка конфигурации

> **Примечание:** Для работы требуется Go версии 1.16+ и доступ к MQTT брокеру